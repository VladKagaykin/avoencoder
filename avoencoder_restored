#include <iostream>
#include <sstream>
#include <iomanip>
#include <vector>
#include <fstream>
#include <string>
#include <cstring>
#include <cstdint>
#include <png.h>

class ImageEncoder {
private:
    std::string hexToText(const std::string& hex) {
        std::string text;
        for (size_t i = 0; i < hex.length(); i += 2) {
            std::string byteString = hex.substr(i, 2);
            char byte = (char)std::stoi(byteString, nullptr, 16);
            text += byte;
        }
        return text;
    }
    
    void hexToFile(const std::string& hex, const std::string& filename) {
        std::ofstream file(filename, std::ios::binary);
        if (!file) {
            std::cerr << "Ошибка создания файла: " << filename << std::endl;
            return;
        }
        
        for (size_t i = 0; i < hex.length(); i += 2) {
            std::string byteString = hex.substr(i, 2);
            char byte = (char)std::stoi(byteString, nullptr, 16);
            file.write(&byte, 1);
        }
        
        std::cout << "Файл восстановлен как: " << filename << std::endl;
    }
    
    std::vector<std::string> splitIntoGroups(const std::string& hexStr, int width) {
        std::vector<std::string> groups;
        int charsPerRow = width * 6; // 6 hex символов на пиксель
        
        for (size_t i = 0; i < hexStr.length(); i += charsPerRow) {
            std::string row = hexStr.substr(i, charsPerRow);
            // Дополняем последнюю строку нулями если нужно
            if (row.length() < charsPerRow) {
                row.append(charsPerRow - row.length(), '0');
            }
            groups.push_back(row);
        }
        return groups;
    }
    
    void createPNG(const std::string& filename, int width, int height, const std::vector<std::string>& hexRows) {
        FILE *fp = fopen(filename.c_str(), "wb");
        if (!fp) {
            std::cerr << "Ошибка создания файла: " << filename << std::endl;
            return;
        }

        png_structp png_ptr = png_create_write_struct(PNG_LIBPNG_VER_STRING, NULL, NULL, NULL);
        if (!png_ptr) {
            fclose(fp);
            std::cerr << "Ошибка создания PNG структуры" << std::endl;
            return;
        }

        png_infop info_ptr = png_create_info_struct(png_ptr);
        if (!info_ptr) {
            png_destroy_write_struct(&png_ptr, NULL);
            fclose(fp);
            std::cerr << "Ошибка создания PNG info структуры" << std::endl;
            return;
        }

        if (setjmp(png_jmpbuf(png_ptr))) {
            png_destroy_write_struct(&png_ptr, &info_ptr);
            fclose(fp);
            std::cerr << "Ошибка во время записи PNG" << std::endl;
            return;
        }

        png_init_io(png_ptr, fp);

        // Используем RGBA для поддержки прозрачности
        png_set_IHDR(png_ptr, info_ptr, width, height, 8, PNG_COLOR_TYPE_RGBA,
                     PNG_INTERLACE_NONE, PNG_COMPRESSION_TYPE_DEFAULT, 
                     PNG_FILTER_TYPE_DEFAULT);

        png_write_info(png_ptr, info_ptr);

        // Создаем данные изображения (RGBA - 4 байта на пиксель)
        std::vector<png_byte> image_data(width * height * 4);
        
        for (int y = 0; y < height; y++) {
            for (int x = 0; x < width; x++) {
                int index = (y * width + x) * 4;
                
                if (y < hexRows.size() && x * 6 < hexRows[y].length()) {
                    std::string pixelHex = hexRows[y].substr(x * 6, 6);
                    // Преобразуем HEX в RGB
                    image_data[index] = std::stoi(pixelHex.substr(0, 2), nullptr, 16);     // R
                    image_data[index + 1] = std::stoi(pixelHex.substr(2, 2), nullptr, 16); // G
                    image_data[index + 2] = std::stoi(pixelHex.substr(4, 2), nullptr, 16); // B
                    image_data[index + 3] = 255; // A - полностью непрозрачный
                } else {
                    // Прозрачные пиксели для пустых областей
                    image_data[index] = 0;     // R
                    image_data[index + 1] = 0; // G
                    image_data[index + 2] = 0; // B
                    image_data[index + 3] = 0; // A - полностью прозрачный
                }
            }
        }

        // Создаем указатели на строки
        std::vector<png_bytep> row_pointers(height);
        for (int y = 0; y < height; y++) {
            row_pointers[y] = &image_data[y * width * 4];
        }

        png_write_image(png_ptr, row_pointers.data());
        png_write_end(png_ptr, NULL);

        png_destroy_write_struct(&png_ptr, &info_ptr);
        fclose(fp);
        
        std::cout << "Изображение сохранено как: " << filename << std::endl;
    }
    
    std::string readPNG(const std::string& filename) {
        FILE *fp = fopen(filename.c_str(), "rb");
        if (!fp) {
            std::cerr << "Ошибка открытия файла: " << filename << std::endl;
            return "";
        }

        png_byte header[8];
        fread(header, 1, 8, fp);
        if (png_sig_cmp(header, 0, 8)) {
            fclose(fp);
            std::cerr << "Это не PNG файл!" << std::endl;
            return "";
        }

        png_structp png_ptr = png_create_read_struct(PNG_LIBPNG_VER_STRING, NULL, NULL, NULL);
        if (!png_ptr) {
            fclose(fp);
            return "";
        }

        png_infop info_ptr = png_create_info_struct(png_ptr);
        if (!info_ptr) {
            png_destroy_read_struct(&png_ptr, NULL, NULL);
            fclose(fp);
            return "";
        }

        if (setjmp(png_jmpbuf(png_ptr))) {
            png_destroy_read_struct(&png_ptr, &info_ptr, NULL);
            fclose(fp);
            return "";
        }

        png_init_io(png_ptr, fp);
        png_set_sig_bytes(png_ptr, 8);
        png_read_info(png_ptr, info_ptr);

        int width = png_get_image_width(png_ptr, info_ptr);
        int height = png_get_image_height(png_ptr, info_ptr);
        png_byte color_type = png_get_color_type(png_ptr, info_ptr);
        png_byte bit_depth = png_get_bit_depth(png_ptr, info_ptr);

        if (bit_depth == 16)
            png_set_strip_16(png_ptr);

        if (color_type == PNG_COLOR_TYPE_PALETTE)
            png_set_palette_to_rgb(png_ptr);

        if (color_type == PNG_COLOR_TYPE_GRAY && bit_depth < 8)
            png_set_expand_gray_1_2_4_to_8(png_ptr);

        if (png_get_valid(png_ptr, info_ptr, PNG_INFO_tRNS))
            png_set_tRNS_to_alpha(png_ptr);

        if (color_type == PNG_COLOR_TYPE_RGB ||
            color_type == PNG_COLOR_TYPE_GRAY ||
            color_type == PNG_COLOR_TYPE_PALETTE)
            png_set_filler(png_ptr, 0xFF, PNG_FILLER_AFTER);

        if (color_type == PNG_COLOR_TYPE_GRAY ||
            color_type == PNG_COLOR_TYPE_GRAY_ALPHA)
            png_set_gray_to_rgb(png_ptr);

        png_read_update_info(png_ptr, info_ptr);

        std::vector<png_bytep> row_pointers(height);
        std::vector<png_byte> image_data(width * height * 4);
        
        for (int y = 0; y < height; y++) {
            row_pointers[y] = &image_data[y * width * 4];
        }

        png_read_image(png_ptr, row_pointers.data());
        fclose(fp);

        png_destroy_read_struct(&png_ptr, &info_ptr, NULL);

        std::cout << "Размер изображения: " << width << "x" << height << std::endl;
        
        std::string hexData;
        for (int y = 0; y < height; y++) {
            for (int x = 0; x < width; x++) {
                int index = (y * width + x) * 4;
                uint8_t r = image_data[index];
                uint8_t g = image_data[index + 1];
                uint8_t b = image_data[index + 2];
                uint8_t a = image_data[index + 3];
                
                // Если пиксель не полностью прозрачный, добавляем его данные
                if (a > 0) {
                    // Преобразуем RGB в HEX
                    std::stringstream hexStream;
                    hexStream << std::hex << std::setw(2) << std::setfill('0') << (int)r
                             << std::setw(2) << std::setfill('0') << (int)g
                             << std::setw(2) << std::setfill('0') << (int)b;
                    
                    hexData += hexStream.str();
                }
            }
        }
        
        return hexData;
    }

public:
    // Перенесенные публичные методы
    std::string textToHex(const std::string& text) {
        std::stringstream hexStream;
        for (unsigned char c : text) {
            hexStream << std::hex << std::setw(2) << std::setfill('0') << (int)c;
        }
        return hexStream.str();
    }
    
    std::string fileToHex(const std::string& filename) {
        std::ifstream file(filename, std::ios::binary);
        if (!file) {
            std::cerr << "Ошибка открытия файла: " << filename << std::endl;
            return "";
        }
        
        // Получаем размер файла
        file.seekg(0, std::ios::end);
        size_t fileSize = file.tellg();
        file.seekg(0, std::ios::beg);
        
        // Читаем файл в буфер
        std::vector<char> buffer(fileSize);
        file.read(buffer.data(), fileSize);
        
        // Конвертируем в HEX
        std::stringstream hexStream;
        for (size_t i = 0; i < fileSize; i++) {
            hexStream << std::hex << std::setw(2) << std::setfill('0') << (int)(unsigned char)buffer[i];
        }
        
        return hexStream.str();
    }

    void encodeToImage(const std::string& data, int width, int height, const std::string& filename = "encoded_data.png") {
        std::vector<std::string> hexRows = splitIntoGroups(data, width);
        
        // Дополняем нулевыми строками если нужно (они будут прозрачными)
        while (hexRows.size() < height) {
            hexRows.push_back(std::string(width * 6, '0'));
        }
        
        createPNG(filename, width, height, hexRows);
    }
    
    void decodeFromImage(const std::string& filename, bool isFile = false, const std::string& outputFilename = "") {
        std::string hexData = readPNG(filename);
        if (hexData.empty()) return;
        
        if (isFile) {
            // Восстанавливаем файл
            std::string outputName = outputFilename.empty() ? "restored_file" : outputFilename;
            hexToFile(hexData, outputName);
        } else {
            // Расшифровываем текст
            std::string text = hexToText(hexData);
            std::cout << "Расшифрованный текст: " << std::endl;
            std::cout << text << std::endl;
            
            // Выводим HEX представление
            std::cout << "HEX представление: ";
            for (size_t i = 0; i < hexData.length(); i += 6) {
                if (i > 0) std::cout << " ";
                std::cout << hexData.substr(i, 6);
            }
            std::cout << std::endl;
        }
    }
    
    void simpleHexEncode(const std::string& text) {
        std::string hexStr = textToHex(text);
        std::vector<std::string> groups;
        
        for (size_t i = 0; i < hexStr.length(); i += 6) {
            std::string group = hexStr.substr(i, 6);
            if (group.length() < 6) {
                group.append(6 - group.length(), '0');
            }
            groups.push_back(group);
        }
        
        for (size_t i = 0; i < groups.size(); i++) {
            std::cout << groups[i];
            if (i != groups.size() - 1) {
                std::cout << " ";
            }
        }
        std::cout << std::endl;
    }
};

int main() {
    ImageEncoder encoder;
    int choice;
    
    std::cout << "Выберите режим:" << std::endl;
    std::cout << "1 - Шифрование текста в HEX" << std::endl;
    std::cout << "2 - Создание изображения с зашифрованными данными" << std::endl;
    std::cout << "3 - Чтение и расшифровка изображения" << std::endl;
    std::cout << "Ваш выбор: ";
    std::cin >> choice;
    std::cin.ignore(); // Очищаем буфер
    
    switch (choice) {
        case 1: {
            std::string text;
            std::cout << "Введите текст для шифрования: ";
            std::getline(std::cin, text);
            encoder.simpleHexEncode(text);
            break;
        }
        case 2: {
            int dataChoice;
            std::cout << "Выберите тип данных для шифрования:" << std::endl;
            std::cout << "1 - Текст" << std::endl;
            std::cout << "2 - Файл" << std::endl;
            std::cout << "Ваш выбор: ";
            std::cin >> dataChoice;
            std::cin.ignore();
            
            std::string data;
            std::string filename;
            int width, height;
            std::string outputFilename;
            
            if (dataChoice == 1) {
                std::string text;
                std::cout << "Введите текст для шифрования: ";
                std::getline(std::cin, text);
                data = encoder.textToHex(text);
            } else if (dataChoice == 2) {
                std::cout << "Введите путь к файлу: ";
                std::getline(std::cin, filename);
                data = encoder.fileToHex(filename);
                if (data.empty()) {
                    std::cout << "Не удалось прочитать файл!" << std::endl;
                    break;
                }
            } else {
                std::cout << "Неверный выбор!" << std::endl;
                break;
            }
            
            std::cout << "Введите ширину изображения: ";
            std::cin >> width;
            std::cout << "Введите высоту изображения: ";
            std::cin >> height;
            std::cin.ignore();
            std::cout << "Введите имя выходного файла (по умолчанию: encoded_data.png): ";
            std::getline(std::cin, outputFilename);
            
            if (outputFilename.empty()) {
                outputFilename = "encoded_data.png";
            }
            
            // Расчет минимального размера изображения
            size_t minPixels = (data.length() + 5) / 6; // Округление вверх
            size_t providedPixels = width * height;
            
            if (providedPixels < minPixels) {
                std::cout << "Внимание: изображение слишком маленькое!" << std::endl;
                std::cout << "Минимальный размер: " << minPixels << " пикселей" << std::endl;
                std::cout << "Предоставленный размер: " << providedPixels << " пикселей" << std::endl;
                std::cout << "Часть данных будет потеряна!" << std::endl;
            }
            
            encoder.encodeToImage(data, width, height, outputFilename);
            break;
        }
        case 3: {
            int decodeChoice;
            std::cout << "Выберите тип расшифровки:" << std::endl;
            std::cout << "1 - Текст" << std::endl;
            std::cout << "2 - Файл" << std::endl;
            std::cout << "Ваш выбор: ";
            std::cin >> decodeChoice;
            std::cin.ignore();
            
            std::string filename;
            std::cout << "Введите имя файла изображения: ";
            std::getline(std::cin, filename);
            
            if (decodeChoice == 1) {
                encoder.decodeFromImage(filename, false);
            } else if (decodeChoice == 2) {
                std::string outputFilename;
                std::cout << "Введите имя для восстановленного файла: ";
                std::getline(std::cin, outputFilename);
                encoder.decodeFromImage(filename, true, outputFilename);
            } else {
                std::cout << "Неверный выбор!" << std::endl;
            }
            break;
        }
        default:
            std::cout << "Неверный выбор!" << std::endl;
    }
    
    return 0;
}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     